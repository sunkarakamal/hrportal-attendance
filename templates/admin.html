<!-- templates/admin.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - HRMS Attendance System</title>
    <link rel="icon" href="{{ url_for('static', filename='uploads/logo.jpeg') }}" type="image/png">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
</head>
<body>
    <div class="container-fluid">
        <!-- Sidebar -->
        <nav class="sidebar-pc" id="sidebar" data-bs-backdrop="false">
            <div class="offcanvas-header">
                <h2 class="offcanvas-title" id="sidebarLabel">Admin Dashboard</h2>
                <button type="button" class="btn-close btn-close-white d-none" data-bs-dismiss="offcanvas" aria-label="Close" id="close-btn"></button>
            </div>
            <div class="offcanvas-body">
                <div class="profile-section">
                    {% if admin_profile and admin_profile.face_image_base64 %}
                    <div class="profile-circle">
                        <img id="admin-profile-pic" src="data:image/jpeg;base64,{{ admin_profile.face_image_base64 }}" alt="Admin Profile">
                    </div>
                    {% else %}
                    <div class="profile-circle">
                        <img id="admin-profile-pic" src="{{ url_for('static', filename='default_profile.jpg') }}" alt="Admin Profile">
                    </div>
                    {% endif %}
                    <div class="profile-info">
                        <p><strong>Admin:</strong> {{ admin_profile.username if admin_profile else 'Admin' }}</p>
                        <p><strong>Email:</strong> <span id="admin-email-display">{{ admin_profile.email if admin_profile else 'admin@example.com' }}</span></p>
                        <input type="email" id="admin-email" value="{{ admin_profile.email if admin_profile else '' }}" placeholder="Email" style="display: none;">
                        <input type="file" id="admin-new-face-image" accept="image/*" style="display: none;">
                        <button id="admin-edit-profile-btn">Edit Profile</button>
                        <button id="admin-save-profile-btn" style="display: none;">Save Changes</button>
                    </div>
                </div>
                <ul class="sidebar-nav">
                    <li class="active" data-section="attendance"><a href="#" class="active"><i class="fas fa-clock"></i> <span class="sidebar-text">Attendance</span></a></li>
                    <li data-section="users"><a href="#"><i class="fas fa-users"></i> <span class="sidebar-text">Manage Users</span></a></li>
                    <li data-section="rota"><a href="#"><i class="fas fa-calendar-week"></i> <span class="sidebar-text">Upload Rota</span></a></li>
                    <li><a href="/register"><i class="fas fa-user"></i>New User</a></li>
                    <li data-section="notifications"><a href="#"><i class="fas fa-bell"></i> <span class="sidebar-text">Notifications</span></a></li>
                    <li data-section="export"><a href="{{ url_for('export_page') }}"><i class="fas fa-file-export"></i> <span class="sidebar-text">Export Data</span></a></li>
                    <li><a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> <span class="sidebar-text">Logout</span></a></li>
                </ul>
            </div>
        </nav>
        <main class="main-content">
            <div class="header">
                <h1>Admin Panel</h1>
                <button class="toggle-btn d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar" aria-controls="sidebar"><i class="fas fa-bars"></i></button>
            </div>
            <div class="flash-messages">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'warning' }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
            </div>

            <!-- Attendance Section -->
            <section class="content-section active" id="attendance">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3>Attendance Overview</h3>
                        <div class="view-selector">
                            <select id="view-select" class="form-select">
                                <option value="daily" {% if view == 'daily' %}selected{% endif %}>Daily</option>
                                <option value="weekly" {% if view == 'weekly' %}selected{% endif %}>Weekly</option>
                                <option value="monthly" {% if view == 'monthly' %}selected{% endif %}>Monthly</option>
                                <option value="yearly" {% if view == 'yearly' %}selected{% endif %}>Yearly</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="search-bar mb-3">
                            <input type="text" id="search-input" class="form-control" placeholder="Search by username..." value="{{ search_query }}">
                            <button id="search-btn" class="btn btn-primary"><i class="fas fa-search"></i> Search</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped" id="attendance-table">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Position</th>
                                        <th>Login Time</th>
                                        <th>Logout Time</th>
                                        <th>Hours Worked</th>
                                        <th>Status</th>
                                        <th>Daily Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in data %}
                                    <tr>
                                        <td>{{ record.username }}</td>
                                        <td>{{ record.position }}</td>
                                        <td>{{ record.login_time|strftime('%Y-%m-%d %H:%M:%S') if record.login_time else 'N/A' }}</td>
                                        <td>{{ record.logout_time|strftime('%Y-%m-%d %H:%M:%S') if record.logout_time else 'N/A' }}</td>
                                        <td><span class="hours-worked" style="color: {{ record.color }};">{{ record.hours_worked }}</span></td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if record.attendance_status == 'Present' else 'danger' }}">{{ record.attendance_status }}</span>
                                        </td>
                                        <td>{{ 'Yes' if record.daily_status_submitted else 'No' }}</td>
                                        <td>
                                            <select class="status-select form-select form-select-sm" data-id="{{ record.attendance_id }}">
                                                <option value="Present" {% if record.attendance_status == 'Present' %}selected{% endif %}>Present</option>
                                                <option value="Absent" {% if record.attendance_status == 'Absent' %}selected{% endif %}>Absent</option>
                                            </select>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div id="all-attendance-section" style="display: none;">
                            <h5>All Attendance Records</h5>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Username</th>
                                            <th>Login Time</th>
                                            <th>Logout Time</th>
                                            <th>Hours Worked</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for record in all_attendance %}
                                        <tr>
                                            <td>{{ record.username }}</td>
                                            <td>{{ record.login_time|strftime('%Y-%m-%d %H:%M:%S') if record.login_time else 'N/A' }}</td>
                                            <td>{{ record.logout_time|strftime('%Y-%m-%d %H:%M:%S') if record.logout_time else 'N/A' }}</td>
                                            <td><span class="hours-worked" style="color: {{ record.color }};">{{ record.hours_worked }}</span></td>
                                            <td><span class="badge bg-{{ 'success' if record.attendance_status == 'Present' else 'danger' }}">{{ record.attendance_status }}</span></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Manage Users Section -->
            <section class="content-section" id="users">
                <div class="card">
                    <h3 class="card-header">Manage Users</h3>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="users-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Position</th>
                                        <th>Profile Image</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in users %}
                                    <tr data-user-id="{{ user.id }}">
                                        <td>{{ user.id }}</td>
                                        <td contenteditable="false">{{ user.username }}</td>
                                        <td contenteditable="false">{{ user.email }}</td>
                                        <td contenteditable="false">{{ user.position }}</td>
                                        <td>
                                            {% if user.face_image_base64 %}
                                            <img src="data:image/jpeg;base64,{{ user.face_image_base64 }}" alt="Profile" class="user-profile-img" style="width: 50px; height: 50px; border-radius: 50%;">
                                            {% else %}
                                            <span>No Image</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-primary edit-user-btn" data-id="{{ user.id }}">Edit</button>
                                            <input type="file" class="new-user-image" accept="image/*" style="display: none;" data-id="{{ user.id }}">
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Upload Rota Section -->
            <section class="content-section" id="rota">
                <div class="card">
                    <h3 class="card-header">Upload Weekly Rota</h3>
                    <div class="card-body">
                        <form id="upload-rota-form">
                            <input type="file" id="rota-image" accept="image/*" class="form-control mb-3" required>
                            <button type="submit" class="btn btn-primary">Upload Rota</button>
                        </form>
                        {% if rota_image_base64 %}
                        <div class="mt-3">
                            <h5>Current Rota</h5>
                            <img src="data:image/jpeg;base64,{{ rota_image_base64 }}" alt="Current Rota" class="rota-image">
                        </div>
                        {% else %}
                        <p class="mt-3">No rota uploaded yet.</p>
                        {% endif %}
                    </div>
                </div>
            </section>

            <!-- Notifications Section -->
            <section class="content-section" id="notifications">
                <div class="card">
                    <h3 class="card-header">Send Notification</h3>
                    <div class="card-body">
                        <form id="send-notification-form">
                            <textarea id="notification-message" class="form-control mb-3" placeholder="Enter notification message..." required></textarea>
                            <button type="submit" class="btn btn-primary">Send to All Users</button>
                        </form>
                    </div>
                </div>
                <div class="card mt-4">
                    <h3 class="card-header">Read Notifications</h3>
                    <div class="card-body">
                        {% if read_notifications %}
                        <ul class="list-group">
                            {% for notif in read_notifications %}
                            <li class="list-group-item">{{ notif.message }} - Sent to {{ notif.username }} on {{ notif.created_at|strftime('%Y-%m-%d %H:%M:%S') }} (Read: {{ notif.read_at|strftime('%Y-%m-%d %H:%M:%S') if notif.read_at else 'N/A' }})</li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p>No read notifications.</p>
                        {% endif %}
                    </div>
                </div>
            </section>

            <!-- Export Section (Redirects to separate page) -->
            <section class="content-section" id="export">
                <div class="card">
                    <h3>Export Attendance Data</h3>
                    <p>Redirecting to export page...</p>
                </div>
            </section>
        </main>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-user-form">
                        <input type="hidden" id="edit-user-id">
                        <div class="mb-3">
                            <label>Username</label>
                            <input type="text" id="edit-username" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label>Email</label>
                            <input type="email" id="edit-email" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label>Position</label>
                            <input type="text" id="edit-position" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label>New Profile Image</label>
                            <input type="file" id="edit-face-image" class="form-control" accept="image/*">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="save-user-btn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script src="{{ url_for('static', filename='js/admin.js') }}"></script>
</body>
</html>
