name: CI/CD — Build → ECR → ECS (Fargate)

on:
  workflow_dispatch:
    inputs:
      deploy:
        description: "confirmation to deploy"
        required: true
        default: "yes"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.ECR_REPOSITORY }}:latest
            ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.ECR_REPOSITORY }}:${{ github.sha }}

      - name: Prepare task definition
        run: |
          IMAGE_URI="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.ECR_REPOSITORY }}:latest"
          sed -e "s|REPLACE_IMAGE_URI|$IMAGE_URI|g" \
              -e "s|REPLACE_TASK_FAMILY|${{ secrets.ECS_TASK_FAMILY }}|g" \
              -e "s|REPLACE_CONTAINER_NAME|${{ secrets.CONTAINER_NAME }}|g" \
              -e "s|REPLACE_DB_HOST|${{ secrets.MARIA_DB_HOST }}|g" \
              -e "s|REPLACE_DB_USER|${{ secrets.MARIA_DB_USER }}|g" \
              -e "s|REPLACE_DB_NAME|${{ secrets.MARIA_DB_NAME }}|g" \
              -e "s|REPLACE_EXECUTION_ROLE_ARN|${{ secrets.ECS_EXECUTION_ROLE_ARN }}|g" \
              -e "s|REPLACE_TASK_ROLE_ARN|${{ secrets.ECS_TASK_ROLE_ARN }}|g" \
              -e "s|REPLACE_SECRETS_MANAGER_ARN_FOR_DB_PASSWORD|${{ secrets.MARIA_DB_PASSWORD_SECRET_ARN }}|g" \
              -e "s|REPLACE_LOG_GROUP|${{ secrets.CLOUDWATCH_LOG_GROUP }}|g" \
              -e "s|REPLACE_REGION|${{ secrets.AWS_REGION }}|g" \
              ecs-task-def.json.tpl > ecs-task-def.json

      - name: Register task & update service
        run: |
          aws ecs register-task-definition --cli-input-json file://ecs-task-def.json
          aws ecs update-service --cluster "${{ secrets.ECS_CLUSTER }}" --service "${{ secrets.ECS_SERVICE }}" --force-new-deployment